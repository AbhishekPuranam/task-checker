services:
  # HashiCorp Vault for Secret Management
  vault:
    image: hashicorp/vault:1.15
    container_name: tasktracker-vault
    restart: unless-stopped
    ports:
      - "8200:8200"
    environment:
      VAULT_ADDR: 'http://0.0.0.0:8200'
      VAULT_DEV_ROOT_TOKEN_ID: 'dev-only-token'  # Only for dev mode
      VAULT_DEV_LISTEN_ADDRESS: '0.0.0.0:8200'
    cap_add:
      - IPC_LOCK
    volumes:
      - vault_data:/vault/file
      - vault_logs:/vault/logs
      - ./vault-config.hcl:/vault/config/vault.hcl:ro
    command: server
    networks:
      - tasktracker-network

  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: tasktracker-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD_FILE: /run/secrets/mongodb_password
      MONGO_INITDB_DATABASE: projecttracker
    volumes:
      - mongodb_data:/data/db
      - ../../scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    secrets:
      - mongodb_password
    networks:
      - tasktracker-network

  # Redis for session storage
  redis:
    image: redis:7-alpine
    container_name: tasktracker-redis
    restart: unless-stopped
    command: /bin/sh -c "redis-server --requirepass $$(cat /run/secrets/redis_password)"
    volumes:
      - redis_data:/data
    secrets:
      - redis_password
    networks:
      - tasktracker-network

  # Backend API
  tasktracker-app:
    build:
      context: ../../services/backend-api
      dockerfile: Dockerfile
      target: production
    container_name: tasktracker-app
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN_FILE: /run/secrets/vault_token
      # Secrets are fetched from Vault at runtime
    volumes:
      - ../../uploads:/app/uploads
      - ../../logs:/app/logs
    secrets:
      - vault_token
      - mongodb_password
      - jwt_secret
      - session_secret
      - redis_password
    depends_on:
      - mongodb
      - redis
      - vault
    networks:
      - tasktracker-network
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.backend.rule=Host(`projects.sapcindia.com`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend.entrypoints=web"
      # HTTPS router
      - "traefik.http.routers.backend-secure.rule=Host(`projects.sapcindia.com`) && PathPrefix(`/api`)"
      - "traefik.http.routers.backend-secure.entrypoints=websecure"
      - "traefik.http.routers.backend-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.backend.loadbalancer.server.port=5000"

  # Auth Service
  tasktracker-auth:
    build:
      context: ../../services/auth-service
      dockerfile: Dockerfile
    container_name: tasktracker-auth
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 4000
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN_FILE: /run/secrets/vault_token
    secrets:
      - vault_token
      - mongodb_password
      - jwt_secret
      - session_secret
    depends_on:
      - mongodb
      - vault
    networks:
      - tasktracker-network
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.auth.rule=Host(`projects.sapcindia.com`) && (Path(`/`) || Path(`/login`) || PathPrefix(`/api/auth`))"
      - "traefik.http.routers.auth.entrypoints=web"
      - "traefik.http.routers.auth.priority=100"
      # HTTPS router
      - "traefik.http.routers.auth-secure.rule=Host(`projects.sapcindia.com`) && (Path(`/`) || Path(`/login`) || PathPrefix(`/api/auth`))"
      - "traefik.http.routers.auth-secure.entrypoints=websecure"
      - "traefik.http.routers.auth-secure.priority=100"
      - "traefik.http.routers.auth-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.auth.loadbalancer.server.port=4000"

  # Admin Client
  tasktracker-admin:
    build:
      context: ../../clients/admin
      dockerfile: Dockerfile
    container_name: tasktracker-admin
    restart: unless-stopped
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: https://projects.sapcindia.com/api
    depends_on:
      - tasktracker-app
    networks:
      - tasktracker-network
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.admin.rule=Host(`projects.sapcindia.com`) && PathPrefix(`/admin`)"
      - "traefik.http.routers.admin.entrypoints=web"
      # HTTPS router
      - "traefik.http.routers.admin-secure.rule=Host(`projects.sapcindia.com`) && PathPrefix(`/admin`)"
      - "traefik.http.routers.admin-secure.entrypoints=websecure"
      - "traefik.http.routers.admin-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.admin.loadbalancer.server.port=3002"

  # Engineer Client
  tasktracker-engineer:
    build:
      context: ../../clients/engineer
      dockerfile: Dockerfile
    container_name: tasktracker-engineer
    restart: unless-stopped
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: https://projects.sapcindia.com/api
    depends_on:
      - tasktracker-app
    networks:
      - tasktracker-network
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.engineer.rule=Host(`projects.sapcindia.com`) && PathPrefix(`/engineer`)"
      - "traefik.http.routers.engineer.entrypoints=web"
      # HTTPS router
      - "traefik.http.routers.engineer-secure.rule=Host(`projects.sapcindia.com`) && PathPrefix(`/engineer`)"
      - "traefik.http.routers.engineer-secure.entrypoints=websecure"
      - "traefik.http.routers.engineer-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.engineer.loadbalancer.server.port=3001"

  # Coroot for Monitoring and Observability
  coroot:
    image: ghcr.io/coroot/coroot:latest
    container_name: tasktracker-coroot
    restart: unless-stopped
    ports:
      - "127.0.0.1:8081:8080"  # Changed to 8081 to avoid conflict with Traefik dashboard
    volumes:
      - coroot_data:/data
      - coroot_cache:/tmp/coroot-cache
    environment:
      - BOOTSTRAP_PROMETHEUS_URL=http://coroot-prometheus:9090
      - BOOTSTRAP_REFRESH_INTERVAL=15s
      - BOOTSTRAP_CLICKHOUSE_ADDRESS=coroot-clickhouse:9000
    depends_on:
      - coroot-prometheus
      - coroot-clickhouse
    networks:
      - tasktracker-network

  # Coroot Node Agent for collecting metrics
  coroot-node-agent:
    image: ghcr.io/coroot/coroot-node-agent:latest
    container_name: tasktracker-coroot-node-agent
    restart: unless-stopped
    privileged: true
    pid: host
    volumes:
      - /sys/kernel/tracing:/sys/kernel/tracing:rw
      - /sys/kernel/debug:/sys/kernel/debug:rw
      - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
      - /:/host/root:ro
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://coroot:8080
      - SCRAPE_INTERVAL=15s
    depends_on:
      - coroot
    networks:
      - tasktracker-network

  # Prometheus for metrics storage
  coroot-prometheus:
    image: prom/prometheus:latest
    container_name: tasktracker-coroot-prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-remote-write-receiver'
      - '--enable-feature=exemplar-storage'
      - '--enable-feature=native-histograms'
    volumes:
      - ./coroot-prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - tasktracker-network

  # ClickHouse for logs and traces
  coroot-clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: tasktracker-coroot-clickhouse
    restart: unless-stopped
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./clickhouse-config.xml:/etc/clickhouse-server/users.d/custom.xml:ro
    networks:
      - tasktracker-network

  # Traefik Reverse Proxy
  traefik:
    image: traefik:v2.10
    container_name: tasktracker-traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - traefik_letsencrypt:/letsencrypt
    networks:
      - tasktracker-network
    labels:
      - "traefik.enable=true"

# Docker Secrets (files mounted as /run/secrets/<secret_name>)
secrets:
  vault_token:
    file: ./secrets/vault_token
  mongodb_password:
    file: ./secrets/mongodb_password
  redis_password:
    file: ./secrets/redis_password
  jwt_secret:
    file: ./secrets/jwt_secret
  session_secret:
    file: ./secrets/session_secret

volumes:
  mongodb_data:
    driver: local
  redis_data:
    driver: local
  traefik_letsencrypt:
    driver: local
  vault_data:
    driver: local
  vault_logs:
    driver: local
  coroot_data:
    driver: local
  coroot_cache:
    driver: local
  prometheus_data:
    driver: local
  clickhouse_data:
    driver: local

networks:
  tasktracker-network:
    driver: bridge
