# SigNoz APM Stack
# This file should be used with: docker compose -f docker-compose.yml -f docker-compose.signoz.yml up -d

services:
  # ClickHouse - Time-series database for traces and metrics
  clickhouse:
    image: clickhouse/clickhouse-server:23.11-alpine
    container_name: signoz-clickhouse
    restart: unless-stopped
    cap_add:
      - SYS_NICE
      - NET_ADMIN
      - IPC_LOCK
    volumes:
      - clickhouse_data:/var/lib/clickhouse/
      - ./signoz/clickhouse-config.xml:/etc/clickhouse-server/config.d/custom-config.xml:ro
    environment:
      - CLICKHOUSE_DB=signoz_traces
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'localhost:8123/ping']
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    networks:
      - tasktracker-network

  # SigNoz Query Service
  query-service:
    image: signoz/query-service:0.43.0
    container_name: signoz-query-service
    restart: unless-stopped
    command: ["-config=/root/config/prometheus.yml"]
    volumes:
      - ./signoz/prometheus.yml:/root/config/prometheus.yml
    environment:
      - ClickHouseUrl=tcp://clickhouse:9000
      - STORAGE=clickhouse
      - GODEBUG=netdns=go
      - DEPLOYMENT_TYPE=docker-standalone-amd
    depends_on:
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - tasktracker-network

  # SigNoz Frontend
  signoz-frontend:
    image: signoz/frontend:0.43.0
    container_name: signoz-frontend
    restart: unless-stopped
    depends_on:
      - query-service
    environment:
      - FRONTEND_API_ENDPOINT=http://query-service:8080
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.signoz.rule=Host(`projects.sapcindia.com`) && PathPrefix(`/admin/signoz`)"
      - "traefik.http.routers.signoz.entrypoints=web"
      - "traefik.http.routers.signoz.priority=110"
      # HTTPS router
      - "traefik.http.routers.signoz-secure.rule=Host(`projects.sapcindia.com`) && PathPrefix(`/admin/signoz`)"
      - "traefik.http.routers.signoz-secure.entrypoints=websecure"
      - "traefik.http.routers.signoz-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.signoz-secure.priority=110"
      # Strip prefix middleware
      - "traefik.http.middlewares.signoz-stripprefix.stripprefix.prefixes=/admin/signoz"
      - "traefik.http.routers.signoz.middlewares=signoz-stripprefix"
      - "traefik.http.routers.signoz-secure.middlewares=signoz-stripprefix"
      # Service
      - "traefik.http.services.signoz.loadbalancer.server.port=3301"
    networks:
      - tasktracker-network

  # OpenTelemetry Collector
  otel-collector:
    image: signoz/signoz-otel-collector:0.88.11
    container_name: signoz-otel-collector
    restart: unless-stopped
    command: ["--config=/etc/otel-collector-config.yaml"]
    user: root
    volumes:
      - ./signoz/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    environment:
      - OTEL_RESOURCE_ATTRIBUTES=host.name=signoz-host,os.type=linux
      - DOCKER_MULTI_NODE_CLUSTER=false
      - LOW_CARDINAL_EXCEPTION_GROUPING=false
    ports:
      - "4317:4317"  # OTLP gRPC receiver
      - "4318:4318"  # OTLP HTTP receiver
    depends_on:
      clickhouse:
        condition: service_healthy
    networks:
      - tasktracker-network

  # SigNoz Alert Manager
  alertmanager:
    image: signoz/alertmanager:0.23.4
    container_name: signoz-alertmanager
    restart: unless-stopped
    volumes:
      - ./signoz/alertmanager-config.yaml:/etc/alertmanager/config.yaml
    command:
      - --queryService.url=http://query-service:8080
      - --storage.path=/data
    depends_on:
      query-service:
        condition: service_healthy
    networks:
      - tasktracker-network

volumes:
  clickhouse_data:
    driver: local

networks:
  tasktracker-network:
    external: true
    name: docker_tasktracker-network
