# Coroot APM Stack
# Based on: https://raw.githubusercontent.com/coroot/coroot/main/deploy/docker-compose.yaml
# This file should be used with: docker compose -f docker-compose.yml -f docker-compose.coroot.yml up -d

services:
  coroot:
    image: ghcr.io/coroot/coroot
    container_name: coroot
    restart: unless-stopped
    user: root
    volumes:
      - coroot_data:/data
    command:
      - '--data-dir=/data'
      - '--bootstrap-prometheus-url=http://prometheus:9090'
      - '--bootstrap-refresh-interval=15s'
      - '--bootstrap-clickhouse-address=clickhouse:9000'
    depends_on:
      - clickhouse
      - prometheus
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.coroot.rule=Host(`projects.sapcindia.com`) && PathPrefix(`/admin/coroot`)"
      - "traefik.http.routers.coroot.entrypoints=web"
      - "traefik.http.routers.coroot.priority=110"
      # HTTPS router
      - "traefik.http.routers.coroot-secure.rule=Host(`projects.sapcindia.com`) && PathPrefix(`/admin/coroot`)"
      - "traefik.http.routers.coroot-secure.entrypoints=websecure"
      - "traefik.http.routers.coroot-secure.tls.certresolver=letsencrypt"
      - "traefik.http.routers.coroot-secure.priority=110"
      # Strip prefix middleware
      - "traefik.http.middlewares.coroot-stripprefix.stripprefix.prefixes=/admin/coroot"
      - "traefik.http.routers.coroot.middlewares=coroot-stripprefix"
      - "traefik.http.routers.coroot-secure.middlewares=coroot-stripprefix"
      # Service
      - "traefik.http.services.coroot.loadbalancer.server.port=8080"
    networks:
      - tasktracker-network

  node-agent:
    image: ghcr.io/coroot/coroot-node-agent
    container_name: coroot-node-agent
    restart: unless-stopped
    privileged: true
    pid: "host"
    volumes:
      - /sys/kernel/tracing:/sys/kernel/tracing:ro
      - /sys/kernel/debug:/sys/kernel/debug:ro
      - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
      - node_agent_data:/data
    command:
      - '--collector-endpoint=http://coroot:8080'
      - '--cgroupfs-root=/host/sys/fs/cgroup'
      - '--wal-dir=/data'
    depends_on:
      - coroot
    networks:
      - tasktracker-network

  cluster-agent:
    image: ghcr.io/coroot/coroot-cluster-agent
    container_name: coroot-cluster-agent
    restart: unless-stopped
    volumes:
      - cluster_agent_data:/data
    command:
      - '--coroot-url=http://coroot:8080'
      - '--metrics-scrape-interval=15s'
      - '--metrics-wal-dir=/data'
    depends_on:
      - coroot
    networks:
      - tasktracker-network

  prometheus:
    image: prom/prometheus:v2.53.5
    container_name: coroot-prometheus
    restart: unless-stopped
    volumes:
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.enable-remote-write-receiver'
    networks:
      - tasktracker-network

  # VictoriaMetrics - lightweight alternative to ClickHouse for traces
  # Works better in Docker without /sys/block permission issues
  victoriametrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: coroot-victoriametrics
    restart: unless-stopped
    volumes:
      - victoriametrics_data:/victoria-metrics-data
    command:
      - '--storageDataPath=/victoria-metrics-data'
      - '--retentionPeriod=30d'
    networks:
      - tasktracker-network

volumes:
  prometheus_data:
    driver: local
  clickhouse_data:
    driver: local
  coroot_data:
    driver: local
  node_agent_data:
    driver: local
  cluster_agent_data:
    driver: local

networks:
  tasktracker-network:
    external: true
    name: docker_tasktracker-network
