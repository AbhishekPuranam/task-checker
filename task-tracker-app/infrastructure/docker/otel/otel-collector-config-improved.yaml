# OpenTelemetry Collector Configuration
# Improved log processing with proper level extraction

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # Docker container logs
  filelog:
    include:
      - /var/lib/docker/containers/*/*.log
    include_file_name: false
    include_file_path: true
    operators:
      # Parse Docker JSON logs
      - type: json_parser
        parse_from: body
        parse_to: attributes
      
      # Extract nested JSON from log field if it exists
      - type: json_parser
        if: 'attributes.log != nil'
        parse_from: attributes.log
        parse_to: attributes.parsed_log
      
      # Map log.level to severity (for Elastic/APM logs)
      - type: severity_parser
        if: 'attributes.parsed_log["log.level"] != nil'
        parse_from: attributes.parsed_log["log.level"]
        mapping:
          error: error
          warn: warn
          warning: warn
          info: info
          debug: debug
          trace: debug
      
      # Map level to severity (for other logs)
      - type: severity_parser
        if: 'attributes.level != nil'
        parse_from: attributes.level
        mapping:
          error: error
          err: error
          warn: warn
          warning: warn
          info: info
          debug: debug
          trace: debug
      
      # Extract container metadata
      - type: regex_parser
        regex: '/var/lib/docker/containers/(?P<container_id>[^/]+)/.*'
        parse_from: attributes["log.file.path"]
      
      # Add resource attributes
      - type: move
        if: 'attributes.container_id != nil'
        from: attributes.container_id
        to: resource["container.id"]
      
      - type: move
        if: 'attributes.container_name != nil'
        from: attributes.container_name
        to: resource["container.name"]

processors:
  # Batch processing
  batch:
    timeout: 10s
    send_batch_size: 1024
    send_batch_max_size: 2048

  # Add resource detection
  resourcedetection:
    detectors: [docker, system, env]
    timeout: 5s

  # Transform processor to extract and normalize severity
  transform:
    log_statements:
      - context: log
        statements:
          # Extract severity from nested JSON attributes
          - set(severity_text, attributes["log.level"]) where attributes["log.level"] != nil
          - set(severity_text, attributes["parsed_log"]["log.level"]) where attributes["parsed_log"]["log.level"] != nil
          - set(severity_text, attributes["level"]) where attributes["level"] != nil
          
          # Normalize severity text
          - replace_pattern(severity_text, "(?i)error", "ERROR")
          - replace_pattern(severity_text, "(?i)warn(ing)?", "WARN")
          - replace_pattern(severity_text, "(?i)info", "INFO")
          - replace_pattern(severity_text, "(?i)debug", "DEBUG")
          - replace_pattern(severity_text, "(?i)trace", "TRACE")
          
          # Map severity_text to severity_number
          - set(severity_number, 17) where severity_text == "ERROR"
          - set(severity_number, 13) where severity_text == "WARN"
          - set(severity_number, 9) where severity_text == "INFO"
          - set(severity_number, 5) where severity_text == "DEBUG"
          - set(severity_number, 1) where severity_text == "TRACE"

  # Memory limiter
  memory_limiter:
    check_interval: 1s
    limit_mib: 512
    spike_limit_mib: 128

exporters:
  # Export to OpenSearch
  opensearch:
    endpoints:
      - http://opensearch:9200
    logs_index: otel-logs
    http:
      timeout: 30s
    auth:
      authenticator: basicauth

  # Debug exporter (optional, for troubleshooting)
  logging:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

extensions:
  basicauth:
    client_auth:
      username: admin
      password: ${OPENSEARCH_PASSWORD}

  health_check:
    endpoint: 0.0.0.0:13133

  pprof:
    endpoint: 0.0.0.0:1777

  zpages:
    endpoint: 0.0.0.0:55679

service:
  extensions: [health_check, pprof, zpages, basicauth]
  
  pipelines:
    # Traces pipeline
    traces:
      receivers: [otlp]
      processors: [memory_limiter, batch, resourcedetection]
      exporters: [opensearch]
    
    # Metrics pipeline
    metrics:
      receivers: [otlp]
      processors: [memory_limiter, batch, resourcedetection]
      exporters: [opensearch]
    
    # Logs pipeline with severity extraction
    logs:
      receivers: [otlp, filelog]
      processors: [memory_limiter, transform, batch, resourcedetection]
      exporters: [opensearch]
      # exporters: [opensearch, logging]  # Uncomment for debugging

  telemetry:
    logs:
      level: info
