# ============================================
# Vector Configuration for OpenSearch
# Separate Index per Service
# ============================================

# ============================================
# SOURCES - Log Collection
# ============================================

# Collect Docker container logs
[sources.docker_logs]
type = "docker_logs"
include_containers = [
  "tasktracker-auth-service",
  "tasktracker-excel-service", 
  "tasktracker-project-service",
  "tasktracker-subproject-service",
  "tasktracker-structural-elements-service",
  "tasktracker-jobs-service",
  "tasktracker-metrics-service",
  "tasktracker-mongodb",
  "tasktracker-redis",
  "tasktracker-traefik",
  "tasktracker-vault",
  "uptime-kuma"
]

# Collect application logs from file system
[sources.app_logs]
type = "file"
include = ["/var/log/app/**/*.log"]
read_from = "beginning"

# ============================================
# TRANSFORMS - Log Processing & Routing
# ============================================

# Base enrichment for all logs
[transforms.enrich]
type = "remap"
inputs = ["docker_logs", "app_logs"]
source = """
  .timestamp = now()
  .environment = "production"
  
  # Extract service name from container name
  if exists(.container_name) {
    .service_name, err = replace(.container_name, r'^tasktracker-', "")
    if err == null && exists(.service_name) {
      .service_name, err2 = replace(.service_name, r'^/', "")
    }
  } else if exists(.file) {
    # Extract from file path
    .service_name, err = replace(.file, r'^.*/([^/]+)\\.log$', "$1")
  }
  
  # Parse log level - Supports emoji logging (üöÄ‚úÖ‚ùå‚ö†Ô∏èüìäüíæ)
  if exists(.message) {
    msg = string(.message)
    if match(msg, r'(?i)(error|err|fatal|critical)') ?? false {
      .level = "error"
    } else if match(msg, r'(?i)(warn|warning)') ?? false {
      .level = "warn"
    } else if match(msg, r'(?i)(info|information)') ?? false {
      .level = "info"
    } else if match(msg, r'(?i)(debug|trace)') ?? false {
      .level = "debug"
    } else {
      .level = "info"
    }
  }
  
  # Try to parse JSON logs
  if exists(.message) {
    parsed, err = parse_json(.message)
    if err == null {
      ., merge_err = merge(., parsed)
    }
  }
  
  # Remove problematic fields
  del(.label)
  del(.labels)
"""

# Route logs based on service name
[transforms.route_by_service]
type = "route"
inputs = ["enrich"]

[transforms.route_by_service.route.auth_service]
type = "vrl"
source = '.service_name == "auth-service"'

[transforms.route_by_service.route.excel_service]
type = "vrl"
source = '.service_name == "excel-service"'

[transforms.route_by_service.route.project_service]
type = "vrl"
source = '.service_name == "project-service"'

[transforms.route_by_service.route.subproject_service]
type = "vrl"
source = '.service_name == "subproject-service"'

[transforms.route_by_service.route.structural_elements_service]
type = "vrl"
source = '.service_name == "structural-elements-service"'

[transforms.route_by_service.route.jobs_service]
type = "vrl"
source = '.service_name == "jobs-service"'

[transforms.route_by_service.route.metrics_service]
type = "vrl"
source = '.service_name == "metrics-service"'

[transforms.route_by_service.route.mongodb]
type = "vrl"
source = '.service_name == "mongodb"'

[transforms.route_by_service.route.redis]
type = "vrl"
source = '.service_name == "redis"'

[transforms.route_by_service.route.traefik]
type = "vrl"
source = '.service_name == "traefik"'

[transforms.route_by_service.route.vault]
type = "vrl"
source = '.service_name == "vault"'

[transforms.route_by_service.route.uptime_kuma]
type = "vrl"
source = '.service_name == "uptime-kuma"'

[transforms.route_by_service.route.admin_ui]
type = "vrl"
source = 'contains(string!(.container_name), "admin")'

[transforms.route_by_service.route.engineer_ui]
type = "vrl"
source = 'contains(string!(.container_name), "engineer")'

[transforms.route_by_service.route.other]
type = "vrl"
source = 'true'

# ============================================
# SINKS - OpenSearch Outputs (Separate Index per Service)
# ============================================

# Auth Service Sink
[sinks.opensearch_auth]
type = "elasticsearch"
inputs = ["route_by_service.auth_service"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_auth.bulk]
index = "logs-auth-service-%Y.%m.%d"

# Excel Service Sink
[sinks.opensearch_excel]
type = "elasticsearch"
inputs = ["route_by_service.excel_service"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_excel.bulk]
index = "logs-excel-service-%Y.%m.%d"

# Project Service Sink
[sinks.opensearch_project]
type = "elasticsearch"
inputs = ["route_by_service.project_service"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_project.bulk]
index = "logs-project-service-%Y.%m.%d"

# SubProject Service Sink
[sinks.opensearch_subproject]
type = "elasticsearch"
inputs = ["route_by_service.subproject_service"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_subproject.bulk]
index = "logs-subproject-service-%Y.%m.%d"

# Structural Elements Service Sink
[sinks.opensearch_structural_elements]
type = "elasticsearch"
inputs = ["route_by_service.structural_elements_service"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_structural_elements.bulk]
index = "logs-structural-elements-service-%Y.%m.%d"

# Jobs Service Sink
[sinks.opensearch_jobs]
type = "elasticsearch"
inputs = ["route_by_service.jobs_service"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_jobs.bulk]
index = "logs-jobs-service-%Y.%m.%d"

# Metrics Service Sink
[sinks.opensearch_metrics]
type = "elasticsearch"
inputs = ["route_by_service.metrics_service"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_metrics.bulk]
index = "logs-metrics-service-%Y.%m.%d"

# MongoDB Sink
[sinks.opensearch_mongodb]
type = "elasticsearch"
inputs = ["route_by_service.mongodb"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_mongodb.bulk]
index = "logs-mongodb-%Y.%m.%d"

# Redis Sink
[sinks.opensearch_redis]
type = "elasticsearch"
inputs = ["route_by_service.redis"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_redis.bulk]
index = "logs-redis-%Y.%m.%d"

# Traefik Sink
[sinks.opensearch_traefik]
type = "elasticsearch"
inputs = ["route_by_service.traefik"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_traefik.bulk]
index = "logs-traefik-%Y.%m.%d"

# Vault Sink
[sinks.opensearch_vault]
type = "elasticsearch"
inputs = ["route_by_service.vault"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_vault.bulk]
index = "logs-vault-%Y.%m.%d"

# Uptime Kuma Sink
[sinks.opensearch_uptime]
type = "elasticsearch"
inputs = ["route_by_service.uptime_kuma"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_uptime.bulk]
index = "logs-uptime-kuma-%Y.%m.%d"

# Admin UI Sink
[sinks.opensearch_admin_ui]
type = "elasticsearch"
inputs = ["route_by_service.admin_ui"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_admin_ui.bulk]
index = "logs-admin-ui-%Y.%m.%d"

# Engineer UI Sink
[sinks.opensearch_engineer_ui]
type = "elasticsearch"
inputs = ["route_by_service.engineer_ui"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_engineer_ui.bulk]
index = "logs-engineer-ui-%Y.%m.%d"

# Other Services Sink (catch-all)
[sinks.opensearch_other]
type = "elasticsearch"
inputs = ["route_by_service.other"]
endpoints = ["http://opensearch:9200"]
mode = "bulk"
api_version = "v8"
suppress_type_name = true
auth.strategy = "basic"
auth.user = "admin"
auth.password = "Admin@123456"

[sinks.opensearch_other.bulk]
index = "logs-other-%Y.%m.%d"

# ============================================
# DEBUG SINK (Optional - for troubleshooting)
# ============================================

# [sinks.console]
# type = "console"
# inputs = ["enrich"]
# encoding.codec = "json"
