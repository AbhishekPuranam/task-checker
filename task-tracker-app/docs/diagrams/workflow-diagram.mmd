flowchart TD
    Start([User Login]) --> Role{User Role?}
    
    Role -->|Admin| AdminDash[Admin Dashboard]
    Role -->|Site Engineer| EngDash[Engineer Dashboard]
    
    AdminDash --> AdminActions{Admin Actions}
    AdminActions --> CreateProject[Create Project]
    AdminActions --> CreateSubProject[Create SubProject]
    AdminActions --> UploadExcel[Upload Excel File]
    AdminActions --> ManageUsers[Manage Users]
    AdminActions --> ViewReports[View Reports & Analytics]
    
    CreateProject --> ProjectCreated[(Project in Tasks Collection)]
    CreateSubProject --> SubProjectCreated[(SubProject Collection)]
    
    UploadExcel --> ExcelQueue[Excel Processing Queue<br/>BullMQ]
    ExcelQueue --> ParseExcel[Parse Excel Rows]
    ParseExcel --> CreateElements[Create Structural Elements]
    CreateElements --> ElementsDB[(Structural Elements Collection)]
    
    ElementsDB --> AutoCreateJobs[Auto-create Jobs<br/>Based on Workflow]
    AutoCreateJobs --> JobsDB[(Jobs Collection)]
    
    JobsDB --> AssignToEngineer[Assign Jobs to Engineers]
    AssignToEngineer --> EngDash
    
    EngDash --> EngActions{Engineer Actions}
    EngActions --> ViewJobs[View Assigned Jobs]
    EngActions --> UpdateJobStatus[Update Job Status]
    EngActions --> UploadPhotos[Upload Progress Photos]
    EngActions --> MarkComplete[Mark Job Complete]
    
    UpdateJobStatus --> JobsDB
    MarkComplete --> JobsDB
    
    JobsDB --> RecalcProgress[Recalculate Progress<br/>Aggregation Worker]
    RecalcProgress --> UpdateSubProject[(Update SubProject Stats)]
    UpdateSubProject --> UpdateProject[(Update Project Progress)]
    
    UpdateProject --> Cache[Redis Cache]
    Cache --> AdminDash
    Cache --> ViewReports
    
    ViewReports --> ExportExcel[Export to Excel]
    ViewReports --> ViewMetrics[View Progress Metrics]
    
    style ExcelQueue fill:#ff6b6b
    style RecalcProgress fill:#ff6b6b
    style Cache fill:#51cf66
    style JobsDB fill:#339af0
    style ElementsDB fill:#339af0
    style ProjectCreated fill:#339af0
    style SubProjectCreated fill:#339af0
